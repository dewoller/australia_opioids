---
title: "Benzo-opioid v2 analysis"
author:  "Mofi Islam and Dennis Wollersheim "
date: "2018-04-30"
output:
workflowr::wflow_html:
toc: false
---

```{r pre_initial, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

rm(list=ls())
options(width = 200)
show_code = FALSE
source("lib/functions.R")
source("lib/mapping_functions.R")
source("lib/standardisation.R")
source("lib/get_data.R")
source("lib/generate_data_frames.R")
library('tidyverse')
opts_chunk$set(echo = FALSE)

```


```{r initial, results='hide', message=FALSE, warning=FALSE}

dataset="_rr"
dataset=""


get_data_from_cache(dataset = dataset)


```
# Methods

The data is from the PBS prescribing data.  In this dataset, we have every opioid and benzodiazepine prescription for a 10% sample of the population, made in the period 2013-2016.  In a single prescription, we have a date of supply, a drug type and strength, and the number of pills.  Using the WHO DDD drug classification, we determine the total DDD for each prescription, and then we estimate the end day of the prescription to be the start day + totalDDD, rounded to the nearest day.  This start and end data comprise the prescription period. 

## Variables

### Independent
* LGA level variables
  * SEIFA
  * urbanisation
  * census data - english language, 2 person household
* Person level variables
  * gender
  * age groups
  * drug of choice
  * user type
  * lga
* Script level variables
  * month of supply
  * drug type - drug name
  * benzo type
  * opioid type


### dependent variables
* benzo and opioid usage (scripts / ddd / number of users / ddd per user / scripts per user  )
* lga level ddd


```{r individual_level_graphs, warning=FALSE}

df %>%
  inner_join( df_patient ) %>%
  group_by( supply_month, sex,  ) %>%
  summarise( n_dose = sum( n_dose ) ) %>%
  ggplot( aes( supply_month, n_dose, fill=sex )) +
  geom_col( position='dodge')

df %>%
  inner_join( df_patient ) %>%
  group_by( supply_month, sex,  ) %>%
  summarise( n = n()) %>%
  ggplot( aes( supply_month, n, fill=sex )) +
  geom_col( position='dodge')


df %>%
  inner_join( df_patient ) %>%
  group_by( supply_month, sex,  ) %>%
  summarise( n = n()) %>%
  ggplot( aes( supply_month, n, group=sex, color=sex )) +
  geom_line( ) 


df %>%
  inner_join( df_patient, by='pin') %>%
  filter( lga != '.' ) %>%
  select_and_standardise_ddd( standardise_over = qc( lga )) %>% 
  { . } -> base_figure_103




base_figure_103 %>%
  inner_join( 
             df_population %>% 
               filter( supply_year==2013)  %>%
               group_by( lga, state ) %>%
               summarise( population = sum( population )), 
             , by='lga' ) %>% 
  filter( !endsWith(lga,  '99' )) %>% 
  { . } -> figure_103

figure_103 %>%
  mutate( plevel = cut( population, c( 0, 1000, 50000, 100000, 150000, 200000, 99999999999 ) )) %>%
  distinct( plevel ) %>%
  ggplot(aes(x = mpg)) +
  geom_dotplot(stackgroups = TRUE, binwidth = 1, dotsize=mtcars$gear/8, stackratio=2.5,method = "histodot")




```


State - urbanisation
There is more variation in rural because rural has smaller towns

asdf

geom_violin

geom_den 

stat_density
stat_density

geom_dotplot

```{r}

    ggplot(mtcars, aes(x = 1, y = mpg, fill = factor(cyl))) +
    geom_dotplot(binaxis = "x", stackgroups = TRUE, dotsize = mtcars$gear, method = "histodot")

  mtcars %>%
    arrange( gear ) %>%
  ggplot(aes(x = mpg)) +
    geom_dotplot(stackgroups = TRUE, binwidth = 1, dotsize=mtcars$gear/8, stackratio=2.5,method = "histodot")


  ggplot(mtcars, aes(x = mpg)) +
    geom_dotplot(binwidth = 1, method = "histodot")

```

