---
title: "Benzo-opioid v2 analysis"
author:  "Mofi Islam and Dennis Wollersheim "
date: "2018-04-30"
output:
workflowr::wflow_html:
toc: false
---

```{r pre_initial, echo=FALSE, results='hide', message=FALSE, warning=FALSE}

rm(list=ls())
options(width = 200)
show_code = FALSE
source("lib/functions.R")
source("lib/mapping_functions.R")
source("lib/standardisation.R")
source("lib/get_data.R")
source("lib/generate_data_frames.R")
library('tidyverse')
opts_chunk$set(echo = FALSE)

```


```{r initial, results='hide', message=FALSE, warning=FALSE}

dataset="_rr"
dataset=""


get_data_from_cache(dataset = dataset)


```


Indeed, Queensland has higher ddd than the rest of the country (barring tasmania)
```{r explore , warning=FALSE}

df %>%
  inner_join( df_patient, by='pin' ) %>%
  inner_join( df_population %>% distinct( lga, seifa, urbanization), by='lga' ) %>%
  filter( lga != '.' ) %>%
  select_and_standardise_ddd( standardise_over = qc( state ))

```
why are there 2 bumps in queensland?

```{r queensland, warning=FALSE  }

df %>%
  inner_join( df_patient, by='pin' ) %>%
  inner_join( df_population %>% distinct( lga, seifa, urbanization, lga_name), by='lga' ) %>%
  filter( lga != '.' & !endsWith( lga, '99') ) %>%
  select_and_standardise_ddd( standardise_over = qc( state, lga, lga_name, seifa, urbanization )) %>%
  arrange( ddd ) %>% 
  { . } -> df_lga_ddd

 

my_db_get_query("select  lga, supply_year, value as lote from  abs_census where measure_id = 'CENSUS_33'", 'mofi') %>%
  as.tibble() %>% 
  { . } -> df_lote

my_db_get_query("select  lga, supply_year, value as gini from  abs_census where measure_id = 'INCOME_41'", 'mofi') %>%
    as.tibble() %>% 
    { . } -> df_gini

qplot( lote, data=df_lote, log='x') -sadgg

df_lga_ddd %>%
  inner_join( filter( df_lote, supply_year==2011 ), by='lga') %>%
  arrange( desc( lote ))


df_lga_ddd %>%
  mutate( b=scale( ddd )) %>%
  ggplot( aes( x=b, fill=factor( seifa)) ) + 
  geom_dotplot(stackgroups=TRUE )


```

range of lga total population adjusted ddd

what do we want to know?

What is happening in QLD
Why is QLD different?

what aspects are QLD different

compare QLD to rest of australia, violin plot every variable 

 



```{r test}


df_lga_ddd %>%
  inner_join( filter( df_lote, supply_year==2011 ), by='lga') %>%
  ggplot( aes( ddd, lote, color=urbanization )) +
  geom_smooth(method = "lm") +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() - sadgg

df_lga_ddd %>% inner_join( filter( df_gini, supply_year==2011 ), by='lga') %>%
    ggplot( aes( ddd, gini, color=seifa )) +
    geom_smooth(method = "lm") +
    scale_x_log10() +
    scale_y_log10() +
    geom_point()  -sadgg


```


```{r state_urbanization, echo=FALSE, fig.cap="state x urbanization", out.width = '100%'}
 

df_lga_ddd%>%
  inner_join( 
             df_population %>% 
               filter( supply_year==2013)  %>%
               filter( lga != '.' ) %>%
               group_by( lga ) %>%
               summarise( population = sum( population )), 
              by=c('lga') ) %>% 




```



